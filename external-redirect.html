<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Production Redirect v162 - URL-Based Persistence</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; background:#000; color:#0f0; font:12px/1.2 sans-serif; }
    .banner { width:320px; height:50px; display:flex; align-items:center; justify-content:center; gap:8px; }
    a { color:#0f0; text-decoration:underline; }
    .sr-only { position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0,0,0,0); }
  </style>
</head>
<body>
  <div class="sr-only">Controller v162</div>
  <div class="banner">
    <a href="#" data-mode="intent">intent</a>
    <a href="#" data-mode="market">market</a>
    <a href="#" data-mode="play">playhttps</a>
    <a href="#" data-mode="chrome">chrome</a>
    <a href="#" data-mode="geo">geo</a>
    <a href="#" data-mode="urlpersist">urlpersist</a>
  </div>

  <script>
    (function(){
      const TAG = '[VUNGLE-CLICK]';
      console.log(TAG, '🔗 PRODUCTION REDIRECT v162 LOADED!');

      const INTENT = 'intent://www.google.com#Intent;scheme=https;action=android.intent.action.VIEW;S.browser_fallback_url=https://www.google.com;end';
      const MARKET = 'market://details?id=com.android.chrome';
      const PLAY = 'https://play.google.com/store/apps/details?id=com.android.chrome';
      const CHROME_NAV = 'googlechrome://navigate?url=' + encodeURIComponent('https://www.google.com');
      const GEO = 'geo:37.4220,-122.0841?q=Googleplex';

      // URL-based parameter parsing
      const urlStr = location.href;
      const modeMatch = urlStr.match(/[?&]mode=([^&]*)/);
      const mode = modeMatch ? modeMatch[1].toLowerCase() : 'intent';
      
      // Extract strategy from URL (for persistence)
      const strategyMatch = urlStr.match(/[?&]strategy=([^&]*)/);
      const urlStrategy = strategyMatch ? parseInt(strategyMatch[1]) : 1;
      
      // Extract attempt count from URL  
      const attemptMatch = urlStr.match(/[?&]attempt=([^&]*)/);
      const urlAttempt = attemptMatch ? parseInt(attemptMatch[1]) : 1;
      
      let attempted = false;
      console.log(TAG, '🔍 FULL URL:', urlStr);
      console.log(TAG, '🔍 MODE EXTRACTED:', mode);
      console.log(TAG, '🔍 STRATEGY FROM URL:', urlStrategy);
      console.log(TAG, '🔍 ATTEMPT FROM URL:', urlAttempt);

      function nav(url, label, useReplace) {
        if (attempted) return;
        attempted = true;
        console.log(TAG, '🚀 Attempt (single) →', label, url);
        try { useReplace ? window.location.replace(url) : window.location.href = url; }
        catch(e){ console.log(TAG, '❌ Exception', label, String(e)); }
      }

      function buildPersistentUrl(strategy, attempt) {
        const baseUrl = 'https://oprelloads.github.io/test-red/external-redirect.html';
        return `${baseUrl}?mode=urlpersist&strategy=${strategy}&attempt=${attempt}`;
      }

      function runSelected() {
        console.log(TAG, '🔍 DEBUG: mode value is "' + mode + '" (length=' + mode.length + ')');
        switch (mode) {
          case 'intent': return nav(INTENT, 'intent', false);
          case 'market': return nav(MARKET, 'market', false);
          case 'play': return nav(PLAY, 'playhttps', true);
          case 'chrome': return nav(CHROME_NAV, 'chrome navigate', false);
          case 'geo': return nav(GEO, 'geo', false);
          case 'urlpersist': 
            console.log(TAG, '🔗 URL PERSIST MODE MATCHED!');
            return runUrlPersistentStrategy();
          default: 
            console.log(TAG, '❌ NO MATCH - using default intent');
            return nav(INTENT, 'intent (default)', false);
        }
      }

      function runUrlPersistentStrategy() {
        if (attempted) return;
        attempted = true;
        
        console.log(TAG, '🔗 URL Persistent Strategy - Crash Recovery');
        console.log(TAG, '📊 Current strategy:', urlStrategy, 'attempt:', urlAttempt);
        
        const nextAttempt = urlAttempt + 1;
        let nextStrategy = urlStrategy;
        
        // If this is attempt 2+ with same strategy, advance to next strategy
        if (urlAttempt > 1) {
          nextStrategy = urlStrategy + 1;
          console.log(TAG, '⏭️ Advancing to strategy', nextStrategy, '(multiple attempts detected)');
        }
        
        switch (urlStrategy) {
          case 1:
            console.log(TAG, '🚀 URL Strategy 1: Market scheme (will redirect to strategy 2 after crash)');
            // Set up next strategy URL for after crash
            setTimeout(() => {
              const nextUrl = buildPersistentUrl(2, 1);
              console.log(TAG, '🔄 Pre-setting strategy 2 URL:', nextUrl);
              try { window.location.href = nextUrl; } catch(e) { console.log(TAG, '❌ Pre-redirect failed:', e); }
            }, 100);
            // Then trigger market scheme (which will likely crash)
            setTimeout(() => {
              console.log(TAG, '🚀 Triggering market scheme...');
              try { window.location.href = MARKET; } catch(e) { console.log(TAG, '❌ Market failed:', e); }
            }, 200);
            break;
            
          case 2:
            console.log(TAG, '🚀 URL Strategy 2: HTTPS Play Store');
            try { window.location.href = PLAY; } catch(e) { console.log(TAG, '❌ HTTPS failed:', e); }
            break;
            
          case 3:
            console.log(TAG, '🚀 URL Strategy 3: Google redirect');
            try { window.location.href = 'https://www.google.com/url?q=' + encodeURIComponent(PLAY); } catch(e) { console.log(TAG, '❌ Google redirect failed:', e); }
            break;
            
          case 4:
            console.log(TAG, '🚀 URL Strategy 4: Direct Google');
            try { window.location.href = 'https://www.google.com'; } catch(e) { console.log(TAG, '❌ Direct Google failed:', e); }
            break;
            
          default:
            console.log(TAG, '🏁 All URL strategies exhausted');
            nav('https://www.google.com', 'final fallback', false);
        }
      }

      window.addEventListener('beforeunload', () => console.log(TAG, '⚡ BEFORE UNLOAD - NAVIGATION'));
      window.addEventListener('pagehide', () => console.log(TAG, '🎉 PAGE HIDE - POSSIBLE EXTERNAL'));
      document.addEventListener('visibilitychange', () => console.log(TAG, '👁️ VISIBILITY:', document.visibilityState));

      // Manual taps (still single-attempt guarded)
      document.querySelectorAll('.banner a').forEach(a => {
        a.addEventListener('click', function(e){ e.preventDefault(); navFor(a.dataset.mode); });
      });

      function navFor(m) {
        switch (m) {
          case 'intent': return nav(INTENT, 'intent (manual)');
          case 'market': return nav(MARKET, 'market (manual)');
          case 'play': return nav(PLAY, 'playhttps (manual)', true);
          case 'chrome': return nav(CHROME_NAV, 'chrome navigate (manual)');
          case 'geo': return nav(GEO, 'geo (manual)');
          case 'urlpersist': return runUrlPersistentStrategy();
        }
      }

      // Auto-run exactly one variant after a brief delay (to allow logs to flush)
      setTimeout(runSelected, 900);
      console.log(TAG, '🧭 mode =', mode, '(pass ?mode=intent|market|play|chrome|geo|urlpersist)');
    })();
  </script>
</body>
</html>
