<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Production Redirect v161 - Crash-Resistant Strategy</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; background:#000; color:#0f0; font:12px/1.2 sans-serif; }
    .banner { width:320px; height:50px; display:flex; align-items:center; justify-content:center; gap:8px; }
    a { color:#0f0; text-decoration:underline; }
    .sr-only { position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0,0,0,0); }
  </style>
</head>
<body>
  <div class="sr-only">Controller v161</div>
  <div class="banner">
    <a href="#" data-mode="intent">intent</a>
    <a href="#" data-mode="market">market</a>
    <a href="#" data-mode="play">playhttps</a>
    <a href="#" data-mode="chrome">chrome</a>
    <a href="#" data-mode="geo">geo</a>
    <a href="#" data-mode="persistent">persistent</a>
  </div>

  <script>
    (function(){
      const TAG = '[VUNGLE-CLICK]';
      console.log(TAG, '🔄 PRODUCTION REDIRECT v161 LOADED!');

      const INTENT = 'intent://www.google.com#Intent;scheme=https;action=android.intent.action.VIEW;S.browser_fallback_url=https://www.google.com;end';
      const MARKET = 'market://details?id=com.android.chrome';
      const PLAY = 'https://play.google.com/store/apps/details?id=com.android.chrome';
      const CHROME_NAV = 'googlechrome://navigate?url=' + encodeURIComponent('https://www.google.com');
      const GEO = 'geo:37.4220,-122.0841?q=Googleplex';

      // More robust parameter parsing
      const urlStr = location.href;
      const modeMatch = urlStr.match(/[?&]mode=([^&]*)/);
      const mode = modeMatch ? modeMatch[1].toLowerCase() : 'intent';
      let attempted = false;
      console.log(TAG, '🔍 FULL URL:', urlStr);
      console.log(TAG, '🔍 MODE EXTRACTED:', mode);

      // Crash-resistant state management
      const STATE_KEY = 'vungle_redirect_state';
      let state = { attempts: 0, lastAttempt: 0, strategy: 1 };
      
      try {
        const saved = localStorage.getItem(STATE_KEY);
        if (saved) {
          state = JSON.parse(saved);
          console.log(TAG, '📁 RESTORED STATE:', state);
        }
      } catch(e) {
        console.log(TAG, '⚠️ localStorage unavailable');
      }

      function saveState() {
        try {
          localStorage.setItem(STATE_KEY, JSON.stringify(state));
          console.log(TAG, '💾 STATE SAVED:', state);
        } catch(e) {
          console.log(TAG, '⚠️ Could not save state');
        }
      }

      function clearState() {
        try {
          localStorage.removeItem(STATE_KEY);
          console.log(TAG, '🗑️ STATE CLEARED');
        } catch(e) {}
      }

      function nav(url, label, useReplace) {
        if (attempted) return;
        attempted = true;
        console.log(TAG, '🚀 Attempt (single) →', label, url);
        try { useReplace ? window.location.replace(url) : window.location.href = url; }
        catch(e){ console.log(TAG, '❌ Exception', label, String(e)); }
      }

      function runSelected() {
        console.log(TAG, '🔍 DEBUG: mode value is "' + mode + '" (length=' + mode.length + ')');
        switch (mode) {
          case 'intent': return nav(INTENT, 'intent', false);
          case 'market': return nav(MARKET, 'market', false);
          case 'play': return nav(PLAY, 'playhttps', true);
          case 'chrome': return nav(CHROME_NAV, 'chrome navigate', false);
          case 'geo': return nav(GEO, 'geo', false);
          case 'persistent': 
            console.log(TAG, '🔄 PERSISTENT MODE MATCHED!');
            return runPersistentStrategy();
          default: 
            console.log(TAG, '❌ NO MATCH - using default intent');
            return nav(INTENT, 'intent (default)', false);
        }
      }

      function runPersistentStrategy() {
        if (attempted) return;
        attempted = true;
        
        const now = Date.now();
        console.log(TAG, '🔄 Persistent Strategy - Crash Recovery');
        console.log(TAG, '📊 Current state:', state);
        
        // If we just attempted something, try the next strategy
        if (state.lastAttempt > 0 && (now - state.lastAttempt) < 10000) {
          state.strategy++;
          console.log(TAG, '⏭️ Moving to strategy', state.strategy, '(recent attempt detected)');
        }
        
        state.attempts++;
        state.lastAttempt = now;
        saveState();
        
        switch (state.strategy) {
          case 1:
            console.log(TAG, '🚀 Persistent Strategy 1: Market scheme');
            try { window.location.href = MARKET; } catch(e) { console.log(TAG, '❌ Market failed:', e); }
            break;
            
          case 2:
            console.log(TAG, '🚀 Persistent Strategy 2: HTTPS Play Store');
            try { window.location.href = PLAY; } catch(e) { console.log(TAG, '❌ HTTPS failed:', e); }
            break;
            
          case 3:
            console.log(TAG, '🚀 Persistent Strategy 3: Google redirect');
            try { window.location.href = 'https://www.google.com/url?q=' + encodeURIComponent(PLAY); } catch(e) { console.log(TAG, '❌ Google redirect failed:', e); }
            break;
            
          case 4:
            console.log(TAG, '🚀 Persistent Strategy 4: Direct Google');
            try { window.location.href = 'https://www.google.com'; } catch(e) { console.log(TAG, '❌ Direct Google failed:', e); }
            break;
            
          default:
            console.log(TAG, '🏁 All strategies exhausted - clearing state');
            clearState();
            nav('https://www.google.com', 'final fallback', false);
        }
      }

      window.addEventListener('beforeunload', () => console.log(TAG, '⚡ BEFORE UNLOAD - NAVIGATION'));
      window.addEventListener('pagehide', () => console.log(TAG, '🎉 PAGE HIDE - POSSIBLE EXTERNAL'));
      document.addEventListener('visibilitychange', () => console.log(TAG, '👁️ VISIBILITY:', document.visibilityState));

      // Manual taps (still single-attempt guarded)
      document.querySelectorAll('.banner a').forEach(a => {
        a.addEventListener('click', function(e){ e.preventDefault(); navFor(a.dataset.mode); });
      });

      function navFor(m) {
        switch (m) {
          case 'intent': return nav(INTENT, 'intent (manual)');
          case 'market': return nav(MARKET, 'market (manual)');
          case 'play': return nav(PLAY, 'playhttps (manual)', true);
          case 'chrome': return nav(CHROME_NAV, 'chrome navigate (manual)');
          case 'geo': return nav(GEO, 'geo (manual)');
          case 'persistent': return runPersistentStrategy();
        }
      }

      // Auto-run exactly one variant after a brief delay (to allow logs to flush)
      setTimeout(runSelected, 900);
      console.log(TAG, '🧭 mode =', mode, '(pass ?mode=intent|market|play|chrome|geo|persistent)');
    })();
  </script>
</body>
</html>
